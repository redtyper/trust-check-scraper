#!/usr/bin/env python3
"""
TrustCheck Scraper Bot
Automatycznie wykrywa oszustwa z grup Facebook i dodaje do bazy
"""

import time
import json
from datetime import datetime
from config import Config
from modules.facebook_scraper import FacebookScraper
from modules.vision_processor import VisionProcessor
from modules.trustcheck_api import TrustCheckAPI

def map_scam_type_to_reason(scam_desc: str, screenshot_type: str) -> str:
    """Mapuje opis oszustwa na kategoriÄ™ w TrustCheck"""
    desc_lower = scam_desc.lower()
    
    if any(word in desc_lower for word in ['wyÅ‚udzenie', 'oszustwo', 'scam', 'przekrÄ™t']):
        return 'SCAM'
    elif any(word in desc_lower for word in ['spam', 'reklama', 'telemarketing']):
        return 'SPAM'
    elif any(word in desc_lower for word in ['towar', 'nie wysÅ‚aÅ‚', 'nie otrzymaÅ‚']):
        return 'TOWAR'
    else:
        return 'SCAM'

def calculate_rating(confidence: str) -> int:
    """Oblicza rating na podstawie confidence"""
    mapping = {
        'high': 1,
        'medium': 2,
        'low': 3
    }
    return mapping.get(confidence, 2)

def process_screenshot(post: dict, vision: VisionProcessor, api: TrustCheckAPI) -> bool:
    """
    Przetwarza pojedynczy screenshot i dodaje zgÅ‚oszenie
    """
    print(f"\n{'='*60}")
    print(f"ğŸ“„ Post: {post['post_url']}")
    print(f"ğŸ‘¤ Autor: {post['author']}")
    
    # Analiza tekstu posta (szybka prefiltracja)
    text_analysis = vision.analyze_post_text(post['text'])
    if not text_analysis.get('is_scam_report'):
        print("â­ï¸  Pomijam - nie jest to zgÅ‚oszenie oszustwa")
        return False
    
    # Przetwarzaj kaÅ¼dy screenshot
    for img_url in post['images'][:3]:  # Max 3 obrazki na post
        print(f"ğŸ–¼ï¸  AnalizujÄ™: {img_url[:60]}...")
        
        # GPT-4 Vision - ekstrakcja danych
        extracted = vision.analyze_screenshot(img_url)
        
        if not extracted:
            print("âš ï¸  Nie udaÅ‚o siÄ™ wyodrÄ™bniÄ‡ danych")
            continue
        
        print(f"ğŸ“Š WyodrÄ™bnione dane:")
        print(f"   ImiÄ™: {extracted.get('scammer_name')}")
        print(f"   Telefon: {extracted.get('phone_number')}")
        print(f"   Konto: {extracted.get('bank_account')}")
        print(f"   Email: {extracted.get('email')}")
        print(f"   Confidence: {extracted.get('confidence')}")
        
        # OkreÅ›l typ zgÅ‚oszenia i wartoÅ›Ä‡ docelowÄ…
        target_type = None
        target_value = None
        
        # Priorytet: telefon > konto > email
        if extracted.get('phone_number'):
            target_type = 'PERSON'
            target_value = extracted['phone_number']
        elif extracted.get('bank_account'):
            target_type = 'PERSON'
            target_value = extracted['bank_account']  # UÅ¼yjemy konta jako identyfikator
        
        if not target_type or not target_value:
            print("âš ï¸  Brak wystarczajÄ…cych danych do zgÅ‚oszenia")
            continue
        
        # SprawdÅº czy juÅ¼ istnieje
        if api.check_if_exists(target_value, target_type):
            print(f"â­ï¸  Pomijam - {target_value} juÅ¼ jest w bazie")
            continue
        
        # Przygotuj dane zgÅ‚oszenia
        report_data = {
            'targetType': target_type,
            'targetValue': target_value,
            'rating': calculate_rating(extracted.get('confidence', 'medium')),
            'reason': map_scam_type_to_reason(
                extracted.get('scam_description', ''),
                extracted.get('screenshot_type', '')
            ),
            'comment': f"{extracted.get('scam_description', 'Oszustwo zgÅ‚oszone przez spoÅ‚ecznoÅ›Ä‡')}",
            
            # Dane OSINT
            'reportedEmail': extracted.get('email'),
            'facebookLink': extracted.get('facebook_link'),
            'screenshotUrl': img_url,
            
            # Dane osobowe oszusta
            'scammerName': extracted.get('scammer_name'),
            'bankAccount': extracted.get('bank_account'),
            
            # Metadane automatyzacji
            'isAutoGenerated': True,
            'sourceUrl': post['post_url']
        }
        
        # WyÅ›lij do TrustCheck
        success = api.submit_report(report_data)
        
        if success:
            print(f"âœ… DODANO ZGÅOSZENIE!")
            return True
    
    return False

def main():
    """GÅ‚Ã³wna pÄ™tla scrapera"""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      TrustCheck Auto-Scraper v1.0                    â•‘
â•‘      Automatyczne wykrywanie oszustw                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    # Inicjalizacja moduÅ‚Ã³w
    print("ğŸ”§ Inicjalizacja...")
    fb_scraper = FacebookScraper(Config.APIFY_API_KEY)
    vision = VisionProcessor(Config.OPENAI_API_KEY)
    api = TrustCheckAPI(Config.TRUSTCHECK_API_URL, Config.TRUSTCHECK_BOT_TOKEN)
    
    print("âœ… Gotowe!\n")
    
    # GÅ‚Ã³wna pÄ™tla
    while True:
        try:
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            print(f"\nğŸ• [{timestamp}] Rozpoczynam skanowanie...")
            
            # 1. Scrapuj posty z Facebooka
            posts = fb_scraper.scrape_group_posts(
                Config.FACEBOOK_GROUP_URL,
                Config.MAX_POSTS_PER_RUN
            )
            
            # 2. Filtruj posty ze screenshotami
            posts_with_images = fb_scraper.filter_posts_with_screenshots(posts)
            
            # 3. Przetwarzaj kaÅ¼dy post
            processed = 0
            added = 0
            
            for post in posts_with_images:
                success = process_screenshot(post, vision, api)
                processed += 1
                if success:
                    added += 1
                
                # Pauza miÄ™dzy requestami (aby nie przekroczyÄ‡ limitÃ³w API)
                time.sleep(2)
            
            print(f"\n{'='*60}")
            print(f"ğŸ“Š PODSUMOWANIE:")
            print(f"   Przetworzono: {processed} postÃ³w")
            print(f"   Dodano zgÅ‚oszeÅ„: {added}")
            print(f"   NastÄ™pne skanowanie za {Config.CHECK_INTERVAL_HOURS}h")
            print(f"{'='*60}\n")
            
            # Czekaj do nastÄ™pnego cyklu
            time.sleep(Config.CHECK_INTERVAL_HOURS * 3600)
            
        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ Zatrzymano scraper. Do zobaczenia!")
            break
        except Exception as e:
            print(f"\nâŒ BÅ‚Ä…d krytyczny: {str(e)}")
            print("â¸ï¸  Czekam 5 minut przed ponownÄ… prÃ³bÄ…...")
            time.sleep(300)

if __name__ == "__main__":
    main()
